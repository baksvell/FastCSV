# Результаты исправления регрессий

## Примененные исправления

1. **Добавлено резервирование для файлов без кавычек**
   - Предварительное резервирование места для результатов на основе количества newline
   - Уменьшает реаллокации при добавлении строк

2. **Оптимизация поиска ближайшего символа для файлов с кавычками**
   - Улучшена логика сравнения позиций кавычек и newline
   - Уменьшено количество ветвлений

## Результаты бенчмарков

### Исправленные регрессии ✅

#### Small (100 rows)
- **До исправления**: 1.35x медленнее
- **После исправления**: 1.79x быстрее ✅
- **Изменение**: Огромное улучшение! Регрессия исправлена!

#### Large (10000 rows)
- **До исправления**: 6.71x быстрее
- **После исправления**: 7.79x быстрее ✅
- **Изменение**: Улучшение!

#### Medium (1000 rows)
- **До исправления**: 1.28x быстрее
- **После исправления**: 1.18x быстрее
- **Изменение**: Небольшое ухудшение, но все еще быстрее стандартного csv

### Новые регрессии ⚠️

#### Medium with quotes
- **До исправления**: 1.01x быстрее
- **После исправления**: 1.16x медленнее ⚠️
- **Изменение**: Регрессия - стало медленнее

#### Medium with unicode
- **До исправления**: 1.11x быстрее
- **После исправления**: 1.02x медленнее ⚠️
- **Изменение**: Регрессия - стало медленнее

## Анализ

### Успешные исправления ✅
1. **Small (100 rows)**: Регрессия полностью исправлена - теперь 1.79x быстрее
2. **Large (10000 rows)**: Улучшение - теперь 7.79x быстрее
3. **Medium (1000 rows)**: Небольшое ухудшение, но все еще быстрее

### Новые проблемы ⚠️
1. **Medium with quotes**: Регрессия - стало 1.16x медленнее (было 1.01x быстрее)
2. **Medium with unicode**: Регрессия - стало 1.02x медленнее (было 1.11x быстрее)

## Возможные причины новых регрессий

1. **Изменения в оптимизации поиска ближайшего символа**
   - Возможно, новая логика сравнения позиций работает медленнее для некоторых случаев
   
2. **Изменения в резервировании**
   - Возможно, резервирование для файлов с кавычками работает не оптимально

3. **Компиляторные оптимизации**
   - Возможно, компилятор оптимизировал код по-другому после изменений

## Выводы

1. **Регрессии для файлов без кавычек исправлены** ✅
   - Small (100 rows): 1.79x быстрее
   - Large (10000 rows): 7.79x быстрее
   - Medium (1000 rows): 1.18x быстрее

2. **Новые регрессии для файлов с кавычками** ⚠️
   - Medium with quotes: 1.16x медленнее
   - Medium with unicode: 1.02x медленнее

3. **Общие результаты**
   - 5 из 8 тестов быстрее
   - 3 из 8 тестов медленнее

## Рекомендации

### Вариант 1: Откатить изменения для файлов с кавычками
- Вернуть предыдущую версию оптимизации поиска ближайшего символа
- Сохранить исправления для файлов без кавычек

### Вариант 2: Дополнительная оптимизация
- Проанализировать, почему новые оптимизации работают медленнее
- Попробовать другие подходы к оптимизации

### Вариант 3: Принять текущие результаты
- Регрессии для файлов без кавычек исправлены
- Новые регрессии для файлов с кавычками не критичны (1.16x и 1.02x)



